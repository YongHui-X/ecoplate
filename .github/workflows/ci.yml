name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # Code Quality & Tests
  # ===========================================================================

  typecheck-backend:
    name: Typecheck Backend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3"
      - run: bun install --ignore-scripts
      - run: cd backend && bunx tsc --noEmit

  typecheck-frontend:
    name: Typecheck Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3"
      - run: bun install --ignore-scripts
      - run: cd frontend && bunx tsc --noEmit

  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    env:
      JWT_SECRET: ci-test-secret
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3"
      - run: bun install --ignore-scripts
      - run: cd backend && bun test

  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3"
      - run: bun install --ignore-scripts
      - run: cd frontend && bun run test:run

  test-recommendation:
    name: Test Recommendation Engine
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: |
          cd recommendation-engine
          pip install -r requirements.txt
          pip install pytest
          pytest test_app.py -v

  build-check:
    name: Build Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3"
      - run: bun install --ignore-scripts
      - run: cd frontend && bun run build

  # ===========================================================================
  # Security Scanning - SAST (Static Application Security Testing)
  # ===========================================================================

  semgrep:
    name: SAST (Semgrep)
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    steps:
      - uses: actions/checkout@v4

      - name: Run Semgrep
        run: |
          semgrep scan --config=auto --json --output=semgrep-report.json . || true
          semgrep scan --config=auto . || true

      - name: Upload Semgrep report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-report
          path: semgrep-report.json
          retention-days: 30
          if-no-files-found: ignore

  python-sast:
    name: Python SAST (Bandit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Bandit
        run: pip install bandit[toml]

      - name: Run Bandit
        run: |
          bandit -r recommendation-engine/ \
            -x recommendation-engine/test_app.py \
            -f json -o bandit-report.json \
            --severity-level medium || true

      - name: Display Bandit results
        if: always()
        run: |
          bandit -r recommendation-engine/ \
            -x recommendation-engine/test_app.py \
            --severity-level medium || true

      - name: Upload Bandit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: bandit-report.json
          retention-days: 30

  # ===========================================================================
  # Security Scanning - Secret Detection
  # ===========================================================================

  secret-scan:
    name: Secret Scanning (Trufflehog)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Trufflehog
        run: |
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin

      - name: Run Trufflehog
        run: |
          trufflehog git file://. --only-verified --json > trufflehog-report.json 2>&1 || true
          echo "=== Secret Scan Results ==="
          trufflehog git file://. --only-verified || true

      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trufflehog-report
          path: trufflehog-report.json
          retention-days: 30
          if-no-files-found: ignore

  # ===========================================================================
  # Security Scanning - SCA (Software Composition Analysis)
  # ===========================================================================

  python-deps:
    name: Python SCA (pip-audit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Run pip-audit
        run: |
          pip-audit -r recommendation-engine/requirements.txt \
            -f json -o pip-audit-report.json || true

      - name: Display results
        if: always()
        run: pip-audit -r recommendation-engine/requirements.txt || true

      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit-report
          path: pip-audit-report.json
          retention-days: 30

  js-deps:
    name: JS SCA (npm audit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Audit backend dependencies
        run: |
          cd backend
          npm install --package-lock-only --ignore-scripts 2>/dev/null || true
          echo "=== Backend npm audit ==="
          npm audit --json > ../backend-audit.json 2>&1 || true
          npm audit || true
        continue-on-error: true

      - name: Audit frontend dependencies
        run: |
          cd frontend
          npm install --package-lock-only --ignore-scripts 2>/dev/null || true
          echo "=== Frontend npm audit ==="
          npm audit --json > ../frontend-audit.json 2>&1 || true
          npm audit || true
        continue-on-error: true

      - name: Upload audit reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: js-audit-reports
          path: |
            backend-audit.json
            frontend-audit.json
          retention-days: 30
          if-no-files-found: ignore

  # ===========================================================================
  # Security Scanning - IaC (Infrastructure as Code)
  # ===========================================================================

  iac-scan:
    name: IaC Scanning (Checkov)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          framework: dockerfile
          output_format: cli,json
          output_file_path: console,checkov-results.json
          soft_fail: true

      - name: Upload Checkov report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkov-report
          path: checkov-results.json
          retention-days: 30
          if-no-files-found: ignore

  # ===========================================================================
  # Security Scanning - License Compliance
  # ===========================================================================

  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Check Python licenses
        run: |
          pip install pip-licenses
          pip install -r recommendation-engine/requirements.txt
          echo "=== Python License Report ==="
          pip-licenses --format=markdown --with-urls | tee python-licenses.md
          echo ""
          echo "=== Checking for problematic licenses ==="
          pip-licenses --fail-on="GPL;AGPL" || echo "Warning: GPL/AGPL licenses detected"

      - name: Upload license report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: python-licenses.md
          retention-days: 30

  # ===========================================================================
  # SBOM Generation (Software Bill of Materials)
  # ===========================================================================

  sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Generate SBOM for repository
        run: |
          syft dir:. -o spdx-json=sbom-repo.spdx.json
          syft dir:. -o cyclonedx-json=sbom-repo.cdx.json

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: |
            sbom-repo.spdx.json
            sbom-repo.cdx.json
          retention-days: 90

  # ===========================================================================
  # Security Gate - Aggregate Results
  # ===========================================================================

  security-gate:
    name: Security Gate
    needs:
      - semgrep
      - python-sast
      - secret-scan
      - python-deps
      - js-deps
      - iac-scan
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check security scan results
        run: |
          echo "=== Security Gate Summary ==="
          echo "Semgrep SAST: ${{ needs.semgrep.result }}"
          echo "Python SAST: ${{ needs.python-sast.result }}"
          echo "Secret Scan: ${{ needs.secret-scan.result }}"
          echo "Python SCA: ${{ needs.python-deps.result }}"
          echo "JS SCA: ${{ needs.js-deps.result }}"
          echo "IaC Scan: ${{ needs.iac-scan.result }}"
          echo ""
          echo "Security gate passed - review artifacts for details"

