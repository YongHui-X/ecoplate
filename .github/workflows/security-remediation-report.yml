name: Security Remediation Report

on:
  workflow_dispatch:
    inputs:
      fix_python:
        description: 'Fix Python dependencies'
        type: boolean
        default: true
      fix_js:
        description: 'Fix JavaScript dependencies'
        type: boolean
        default: true
      create_pr:
        description: 'Create PR with fixes'
        type: boolean
        default: true

  schedule:
    - cron: '0 0 * * 0'  # Every Sunday

jobs:
  # ===========================================================================
  # Phase 1: Identify Issues (Pre-Fix Scan)
  # ===========================================================================

  pre-scan-python:
    name: "Phase 1: Python Pre-Fix Scan"
    runs-on: ubuntu-latest
    outputs:
      has_vulnerabilities: ${{ steps.scan.outputs.has_vulns }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install scanning tools
        run: pip install pip-audit bandit

      - name: Scan Python dependencies
        id: scan
        run: |
          echo "# Python Dependencies â€” Before Fixes" > python-pre-scan.md
          echo "" >> python-pre-scan.md
          echo "Scanned on $(date -u '+%B %d, %Y at %H:%M UTC')" >> python-pre-scan.md
          echo "" >> python-pre-scan.md

          echo "## What We Found" >> python-pre-scan.md
          echo "" >> python-pre-scan.md
          echo '```' >> python-pre-scan.md

          if pip-audit -r recommendation-engine/requirements.txt 2>&1 | tee -a python-pre-scan.md; then
            echo "has_vulns=false" >> $GITHUB_OUTPUT
          else
            echo "has_vulns=true" >> $GITHUB_OUTPUT
          fi

          echo '```' >> python-pre-scan.md

          # Also generate JSON for later comparison
          pip-audit -r recommendation-engine/requirements.txt -f json -o python-pre-scan.json 2>/dev/null || true

      - name: Scan Python code (Bandit)
        run: |
          echo "" >> python-pre-scan.md
          echo "## Code Security Issues" >> python-pre-scan.md
          echo "" >> python-pre-scan.md
          echo "We also scanned the Python code itself for security problems:" >> python-pre-scan.md
          echo "" >> python-pre-scan.md
          echo '```' >> python-pre-scan.md
          bandit -r recommendation-engine/ -x recommendation-engine/test_app.py --severity-level medium 2>&1 | tee -a python-pre-scan.md || true
          echo '```' >> python-pre-scan.md

      - name: Upload pre-scan report
        uses: actions/upload-artifact@v4
        with:
          name: python-pre-scan
          path: |
            python-pre-scan.md
            python-pre-scan.json
          retention-days: 30

  pre-scan-js:
    name: "Phase 1: JavaScript Pre-Fix Scan"
    runs-on: ubuntu-latest
    outputs:
      has_vulnerabilities: ${{ steps.scan.outputs.has_vulns }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Scan JavaScript dependencies
        id: scan
        run: |
          echo "# JavaScript Dependencies â€” Before Fixes" > js-pre-scan.md
          echo "" >> js-pre-scan.md
          echo "Scanned on $(date -u '+%B %d, %Y at %H:%M UTC')" >> js-pre-scan.md
          echo "" >> js-pre-scan.md

          HAS_VULNS=false

          echo "## Backend (Node.js API)" >> js-pre-scan.md
          echo "" >> js-pre-scan.md
          echo '```' >> js-pre-scan.md
          cd backend
          npm install --package-lock-only --ignore-scripts 2>/dev/null || true
          if ! npm audit 2>&1 | tee -a ../js-pre-scan.md; then
            HAS_VULNS=true
          fi
          npm audit --json > ../backend-pre-scan.json 2>/dev/null || true
          echo '```' >> ../js-pre-scan.md
          cd ..

          echo "" >> js-pre-scan.md
          echo "## Frontend (React App)" >> js-pre-scan.md
          echo "" >> js-pre-scan.md
          echo '```' >> js-pre-scan.md
          cd frontend
          npm install --package-lock-only --ignore-scripts 2>/dev/null || true
          if ! npm audit 2>&1 | tee -a ../js-pre-scan.md; then
            HAS_VULNS=true
          fi
          npm audit --json > ../frontend-pre-scan.json 2>/dev/null || true
          echo '```' >> ../js-pre-scan.md

          echo "has_vulns=$HAS_VULNS" >> $GITHUB_OUTPUT

      - name: Upload pre-scan report
        uses: actions/upload-artifact@v4
        with:
          name: js-pre-scan
          path: |
            js-pre-scan.md
            backend-pre-scan.json
            frontend-pre-scan.json
          retention-days: 30

  # ===========================================================================
  # Phase 2: Apply Fixes
  # ===========================================================================

  apply-fixes:
    name: "Phase 2: Apply Fixes"
    needs: [pre-scan-python, pre-scan-js]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install tools
        run: pip install pip-audit

      - name: Create fixes report
        run: |
          echo "# Fixes Applied" > fixes-applied.md
          echo "" >> fixes-applied.md
          echo "Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> fixes-applied.md
          echo "" >> fixes-applied.md

      - name: Fix Python dependencies
        if: ${{ github.event_name == 'schedule' || inputs.fix_python }}
        run: |
          echo "## Python Dependency Fixes" >> fixes-applied.md
          echo "" >> fixes-applied.md

          echo "### Before Fix (requirements.txt)" >> fixes-applied.md
          echo '```' >> fixes-applied.md
          cat recommendation-engine/requirements.txt >> fixes-applied.md
          echo '```' >> fixes-applied.md
          echo "" >> fixes-applied.md

          echo "### Applying pip-audit --fix..." >> fixes-applied.md
          echo '```' >> fixes-applied.md
          pip-audit -r recommendation-engine/requirements.txt --fix 2>&1 | tee -a fixes-applied.md || true
          echo '```' >> fixes-applied.md
          echo "" >> fixes-applied.md

          echo "### After Fix (requirements.txt)" >> fixes-applied.md
          echo '```' >> fixes-applied.md
          cat recommendation-engine/requirements.txt >> fixes-applied.md
          echo '```' >> fixes-applied.md
          echo "" >> fixes-applied.md

      - name: Fix Backend JavaScript dependencies
        if: ${{ github.event_name == 'schedule' || inputs.fix_js }}
        run: |
          echo "## Backend JavaScript Fixes" >> fixes-applied.md
          echo "" >> fixes-applied.md

          cd backend
          npm install --package-lock-only --ignore-scripts 2>/dev/null || true

          echo "### Applying npm audit fix..." >> ../fixes-applied.md
          echo '```' >> ../fixes-applied.md
          npm audit fix 2>&1 | tee -a ../fixes-applied.md || true
          echo '```' >> ../fixes-applied.md
          echo "" >> ../fixes-applied.md

      - name: Fix Frontend JavaScript dependencies
        if: ${{ github.event_name == 'schedule' || inputs.fix_js }}
        run: |
          echo "## Frontend JavaScript Fixes" >> fixes-applied.md
          echo "" >> fixes-applied.md

          cd frontend
          npm install --package-lock-only --ignore-scripts 2>/dev/null || true

          echo "### Applying npm audit fix..." >> ../fixes-applied.md
          echo '```' >> ../fixes-applied.md
          npm audit fix 2>&1 | tee -a ../fixes-applied.md || true
          echo '```' >> ../fixes-applied.md
          echo "" >> ../fixes-applied.md

      - name: Upload fixes report
        uses: actions/upload-artifact@v4
        with:
          name: fixes-applied
          path: fixes-applied.md
          retention-days: 30

      - name: Upload fixed files
        uses: actions/upload-artifact@v4
        with:
          name: fixed-files
          path: |
            recommendation-engine/requirements.txt
            backend/package.json
            backend/package-lock.json
            frontend/package.json
            frontend/package-lock.json
          retention-days: 30
          if-no-files-found: ignore

  # ===========================================================================
  # Phase 3: Re-Scan After Fixes
  # ===========================================================================

  post-scan-python:
    name: "Phase 3: Python Post-Fix Scan"
    needs: apply-fixes
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download fixed files
        uses: actions/download-artifact@v4
        with:
          name: fixed-files
          path: ./

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install scanning tools
        run: pip install pip-audit bandit

      - name: Re-scan Python dependencies
        run: |
          echo "# Python Dependencies â€” After Fixes" > python-post-scan.md
          echo "" >> python-post-scan.md
          echo "Scanned on $(date -u '+%B %d, %Y at %H:%M UTC')" >> python-post-scan.md
          echo "" >> python-post-scan.md

          echo "## What's Still There" >> python-post-scan.md
          echo "" >> python-post-scan.md
          echo "If there are still issues below, they couldn't be fixed automatically:" >> python-post-scan.md
          echo "" >> python-post-scan.md
          echo '```' >> python-post-scan.md
          pip-audit -r recommendation-engine/requirements.txt 2>&1 | tee -a python-post-scan.md || true
          echo '```' >> python-post-scan.md

          pip-audit -r recommendation-engine/requirements.txt -f json -o python-post-scan.json 2>/dev/null || true

      - name: Re-scan Python code
        run: |
          echo "" >> python-post-scan.md
          echo "## Code Security Issues" >> python-post-scan.md
          echo "" >> python-post-scan.md
          echo "Note: Code issues require manual fixes â€” they can't be auto-remediated." >> python-post-scan.md
          echo "" >> python-post-scan.md
          echo '```' >> python-post-scan.md
          bandit -r recommendation-engine/ -x recommendation-engine/test_app.py --severity-level medium 2>&1 | tee -a python-post-scan.md || true
          echo '```' >> python-post-scan.md

      - name: Upload post-scan report
        uses: actions/upload-artifact@v4
        with:
          name: python-post-scan
          path: |
            python-post-scan.md
            python-post-scan.json
          retention-days: 30

  post-scan-js:
    name: "Phase 3: JavaScript Post-Fix Scan"
    needs: apply-fixes
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download fixed files
        uses: actions/download-artifact@v4
        with:
          name: fixed-files
          path: ./

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Re-scan JavaScript dependencies
        run: |
          echo "# JavaScript Dependencies â€” After Fixes" > js-post-scan.md
          echo "" >> js-post-scan.md
          echo "Scanned on $(date -u '+%B %d, %Y at %H:%M UTC')" >> js-post-scan.md
          echo "" >> js-post-scan.md
          echo "If there are still issues below, they couldn't be fixed automatically." >> js-post-scan.md
          echo "" >> js-post-scan.md

          echo "## Backend (Node.js API)" >> js-post-scan.md
          echo "" >> js-post-scan.md
          echo '```' >> js-post-scan.md
          cd backend
          npm install --package-lock-only --ignore-scripts 2>/dev/null || true
          npm audit 2>&1 | tee -a ../js-post-scan.md || true
          npm audit --json > ../backend-post-scan.json 2>/dev/null || true
          echo '```' >> ../js-post-scan.md
          cd ..

          echo "" >> js-post-scan.md
          echo "## Frontend (React App)" >> js-post-scan.md
          echo "" >> js-post-scan.md
          echo '```' >> js-post-scan.md
          cd frontend
          npm install --package-lock-only --ignore-scripts 2>/dev/null || true
          npm audit 2>&1 | tee -a ../js-post-scan.md || true
          npm audit --json > ../frontend-post-scan.json 2>/dev/null || true
          echo '```' >> ../js-post-scan.md

      - name: Upload post-scan report
        uses: actions/upload-artifact@v4
        with:
          name: js-post-scan
          path: |
            js-post-scan.md
            backend-post-scan.json
            frontend-post-scan.json
          retention-days: 30

  # ===========================================================================
  # Phase 4: Generate Comprehensive Report
  # ===========================================================================

  generate-report:
    name: "Phase 4: Generate Remediation Report"
    needs: [post-scan-python, post-scan-js]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate comprehensive report
        run: |
          cat > remediation-report.md << 'EOF'
          # Security Remediation Report

          **When:** $(date -u '+%B %d, %Y at %H:%M UTC')
          **Repository:** ${{ github.repository }}
          **Branch:** ${{ github.ref_name }}

          ---

          ## What This Report Covers

          We ran our weekly security scans and attempted to automatically fix any vulnerabilities found. Here's what happened:

          1. **Before** â€” What we found when we scanned the codebase
          2. **What We Fixed** â€” The changes we made automatically
          3. **After** â€” What's left after the fixes (if anything)

          ---

          # Python Dependencies

          ## What We Found (Before Fixes)

          EOF

          if [ -f artifacts/python-pre-scan/python-pre-scan.md ]; then
            cat artifacts/python-pre-scan/python-pre-scan.md >> remediation-report.md
          else
            echo "No pre-scan data available." >> remediation-report.md
          fi

          cat >> remediation-report.md << 'EOF'

          ---

          ## What We Changed

          EOF

          if [ -f artifacts/fixes-applied/fixes-applied.md ]; then
            grep -A 1000 "## Python Dependency Fixes" artifacts/fixes-applied/fixes-applied.md | grep -B 1000 -m 1 "## Backend JavaScript Fixes" | head -n -1 >> remediation-report.md || cat artifacts/fixes-applied/fixes-applied.md >> remediation-report.md
          else
            echo "No fixes data available." >> remediation-report.md
          fi

          cat >> remediation-report.md << 'EOF'

          ---

          ## What's Left (After Fixes)

          EOF

          if [ -f artifacts/python-post-scan/python-post-scan.md ]; then
            cat artifacts/python-post-scan/python-post-scan.md >> remediation-report.md
          else
            echo "No post-scan data available." >> remediation-report.md
          fi

          cat >> remediation-report.md << 'EOF'

          ---

          # JavaScript Dependencies

          ## What We Found (Before Fixes)

          EOF

          if [ -f artifacts/js-pre-scan/js-pre-scan.md ]; then
            cat artifacts/js-pre-scan/js-pre-scan.md >> remediation-report.md
          else
            echo "No pre-scan data available." >> remediation-report.md
          fi

          cat >> remediation-report.md << 'EOF'

          ---

          ## What We Changed

          EOF

          if [ -f artifacts/fixes-applied/fixes-applied.md ]; then
            grep -A 1000 "## Backend JavaScript Fixes" artifacts/fixes-applied/fixes-applied.md >> remediation-report.md || echo "See fixes-applied artifact." >> remediation-report.md
          else
            echo "No fixes data available." >> remediation-report.md
          fi

          cat >> remediation-report.md << 'EOF'

          ---

          ## What's Left (After Fixes)

          EOF

          if [ -f artifacts/js-post-scan/js-post-scan.md ]; then
            cat artifacts/js-post-scan/js-post-scan.md >> remediation-report.md
          else
            echo "No post-scan data available." >> remediation-report.md
          fi

          cat >> remediation-report.md << 'EOF'

          ---

          # Summary

          ## Progress at a Glance

          | Area | Before | After | Status |
          |------|--------|-------|--------|
          | Python packages | Check pre-scan above | Check post-scan above | Review needed |
          | Backend JS packages | Check pre-scan above | Check post-scan above | Review needed |
          | Frontend JS packages | Check pre-scan above | Check post-scan above | Review needed |

          ## What You Should Do Next

          If there are still issues after the automatic fixes:

          1. **Check the "After" sections** â€” Some vulnerabilities can't be auto-fixed (breaking changes, no patch available)
          2. **Manually update problematic packages** â€” Look for alternatives or pin to safe versions
          3. **Re-run this workflow** â€” After your manual fixes, trigger this workflow again to verify

          ## Why Some Issues Remain

          Not everything can be fixed automatically:
          - **Breaking changes** â€” The fix might break your code
          - **No patch yet** â€” The vulnerability was just disclosed
          - **Transitive dependencies** â€” The vulnerable package is buried deep in your dependency tree

          ---

          *This report was generated automatically. If something looks wrong, check the workflow logs.*
          EOF

      - name: Upload comprehensive report
        uses: actions/upload-artifact@v4
        with:
          name: remediation-report
          path: remediation-report.md
          retention-days: 90

      - name: Post summary to GitHub
        run: |
          echo "# Weekly Security Fix Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "We scanned for vulnerabilities and tried to fix them automatically. Here's what happened:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## What's in Each File" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | What It Shows |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---------------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`python-pre-scan\` | Issues we found in Python packages |" >> $GITHUB_STEP_SUMMARY
          echo "| \`js-pre-scan\` | Issues we found in JavaScript packages |" >> $GITHUB_STEP_SUMMARY
          echo "| \`fixes-applied\` | What we changed to fix things |" >> $GITHUB_STEP_SUMMARY
          echo "| \`python-post-scan\` | What's left after Python fixes |" >> $GITHUB_STEP_SUMMARY
          echo "| \`js-post-scan\` | What's left after JavaScript fixes |" >> $GITHUB_STEP_SUMMARY
          echo "| **\`remediation-report\`** | **Full before/after comparison** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ Download \`remediation-report\` for the complete picture." >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Phase 5: Create PR with Fixes (Optional)
  # ===========================================================================

  create-pr:
    name: "Phase 5: Create Pull Request"
    needs: [generate-report]
    if: ${{ github.event_name == 'schedule' || inputs.create_pr }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download fixed files
        uses: actions/download-artifact@v4
        with:
          name: fixed-files
          path: ./
        continue-on-error: true

      - name: Download remediation report
        uses: actions/download-artifact@v4
        with:
          name: remediation-report
          path: ./

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "fix(security): auto-remediate vulnerabilities"
          title: "Weekly Security Fixes"
          body: |
            ## What's in This PR

            Our weekly security scan found some vulnerable dependencies, and we've automatically updated them to safer versions.

            ### Changes Made

            - **Python packages** â€” Updated via `pip-audit --fix`
            - **JavaScript packages** â€” Updated via `npm audit fix`

            ### Before You Merge

            1. **Check the workflow run** â€” Download `remediation-report` to see exactly what changed
            2. **Make sure tests pass** â€” The CI should run automatically
            3. **Quick sanity check** â€” Does the app still work as expected?

            ### If Something Broke

            Some updates might cause issues:
            - Check `fixes-applied` to see what was updated
            - You might need to pin a specific version or find an alternative package

            ---
            *This PR was created automatically by our weekly security scan.*
          branch: security/auto-remediation
          labels: |
            security
            dependencies
            automated
